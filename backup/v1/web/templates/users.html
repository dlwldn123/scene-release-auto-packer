{% extends "base.html" %}

{% block title %}Gestion Utilisateurs - Scene Packer{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="gradient-text">
            <i class="fas fa-users-cog"></i> Gestion des Utilisateurs
        </h1>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createUserModal">
            <i class="fas fa-user-plus"></i> Nouvel Utilisateur
        </button>
    </div>

    <div class="card slide-up">
        <div class="card-body">
            <div id="users-list" class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nom d'utilisateur</th>
                            <th>Email</th>
                            <th>Rôle</th>
                            <th>Créé le</th>
                            <th>Dernière connexion</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="users-table-body">
                        <tr>
                            <td colspan="7" class="text-center">
                                <i class="fas fa-spinner fa-spin"></i> Chargement...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal Création Utilisateur -->
<div class="modal fade" id="createUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Nouvel Utilisateur</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="create-user-form">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="create-username" class="form-label">Nom d'utilisateur *</label>
                        <input type="text" class="form-control" id="create-username" required>
                    </div>
                    <div class="mb-3">
                        <label for="create-password" class="form-label">Mot de passe *</label>
                        <input type="password" class="form-control" id="create-password" required>
                    </div>
                    <div class="mb-3">
                        <label for="create-email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="create-email">
                    </div>
                    <div class="mb-3">
                        <label for="create-role" class="form-label">Rôle *</label>
                        <select class="form-select" id="create-role" required>
                            <option value="operator">Opérateur</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div id="create-user-error" class="alert alert-danger" style="display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary">Créer</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Édition Utilisateur -->
<div class="modal fade" id="editUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Modifier Utilisateur</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="edit-user-form">
                <input type="hidden" id="edit-user-id">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="edit-username" class="form-label">Nom d'utilisateur</label>
                        <input type="text" class="form-control" id="edit-username" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="edit-email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="edit-email">
                    </div>
                    <div class="mb-3">
                        <label for="edit-role" class="form-label">Rôle</label>
                        <select class="form-select" id="edit-role">
                            <option value="operator">Opérateur</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="edit-password" class="form-label">Nouveau mot de passe (laisser vide pour ne pas changer)</label>
                        <input type="password" class="form-control" id="edit-password">
                    </div>
                    <div id="edit-user-error" class="alert alert-danger" style="display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Vérifier que l'utilisateur est admin
    const userData = getUserData();
    if (!userData || userData.role !== 'admin') {
        window.location.href = '/';
        return;
    }

    // Charger liste utilisateurs
    loadUsers();

    // Formulaire création
    document.getElementById('create-user-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const errorDiv = document.getElementById('create-user-error');
        errorDiv.style.display = 'none';

        try {
            const data = await apiRequest('/api/users', {
                method: 'POST',
                body: JSON.stringify({
                    username: document.getElementById('create-username').value,
                    password: document.getElementById('create-password').value,
                    email: document.getElementById('create-email').value || null,
                    role: document.getElementById('create-role').value,
                }),
            });

            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('createUserModal')).hide();
                document.getElementById('create-user-form').reset();
                loadUsers();
                showToast('Utilisateur créé avec succès', 'success');
            }
        } catch (error) {
            errorDiv.textContent = error.message;
            errorDiv.style.display = 'block';
        }
    });

    // Formulaire édition
    document.getElementById('edit-user-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const errorDiv = document.getElementById('edit-user-error');
        errorDiv.style.display = 'none';

        const userId = document.getElementById('edit-user-id').value;
        const updateData = {
            email: document.getElementById('edit-email').value || null,
            role: document.getElementById('edit-role').value,
        };

        const password = document.getElementById('edit-password').value;
        if (password) {
            updateData.password = password;
        }

        try {
            const data = await apiRequest(`/api/users/${userId}`, {
                method: 'PUT',
                body: JSON.stringify(updateData),
            });

            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide();
                document.getElementById('edit-user-form').reset();
                loadUsers();
                showToast('Utilisateur modifié avec succès', 'success');
            }
        } catch (error) {
            errorDiv.textContent = error.message;
            errorDiv.style.display = 'block';
        }
    });

    async function loadUsers() {
        try {
            const data = await apiRequest('/api/users');
            const tbody = document.getElementById('users-table-body');
            
            if (data.users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Aucun utilisateur</td></tr>';
                return;
            }

            tbody.innerHTML = data.users.map(user => {
                const createdDate = new Date(user.created_at).toLocaleDateString('fr-FR');
                const lastLogin = user.last_login ? new Date(user.last_login).toLocaleDateString('fr-FR') : 'Jamais';
                const roleBadge = user.role === 'admin' ? '<span class="badge bg-danger">Admin</span>' : '<span class="badge bg-secondary">Opérateur</span>';
                
                return `
                    <tr>
                        <td>${user.id}</td>
                        <td>${user.username}</td>
                        <td>${user.email || '-'}</td>
                        <td>${roleBadge}</td>
                        <td>${createdDate}</td>
                        <td>${lastLogin}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="editUser(${user.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteUser(${user.id}, '${user.username}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        } catch (error) {
            document.getElementById('users-table-body').innerHTML = 
                `<tr><td colspan="7" class="text-center text-danger">Erreur: ${error.message}</td></tr>`;
        }
    }

    window.editUser = async function(userId) {
        try {
            const data = await apiRequest(`/api/users/${userId}`);
            if (data.success) {
                document.getElementById('edit-user-id').value = data.user.id;
                document.getElementById('edit-username').value = data.user.username;
                document.getElementById('edit-email').value = data.user.email || '';
                document.getElementById('edit-role').value = data.user.role;
                document.getElementById('edit-password').value = '';
                
                const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
                modal.show();
            }
        } catch (error) {
            showToast('Erreur: ' + error.message, 'danger');
        }
    };

    window.deleteUser = async function(userId, username) {
        if (!confirm(`Êtes-vous sûr de vouloir supprimer l'utilisateur "${username}" ?`)) {
            return;
        }

        try {
            const data = await apiRequest(`/api/users/${userId}`, {
                method: 'DELETE',
            });

            if (data.success) {
                showToast('Utilisateur supprimé avec succès', 'success');
                loadUsers();
            }
        } catch (error) {
            showToast('Erreur: ' + error.message, 'danger');
        }
    };

    // Fonction toast helper
    function showToast(message, type = 'info') {
        const toastContainer = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-white bg-${type} border-0`;
        toast.setAttribute('role', 'alert');
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;
        toastContainer.appendChild(toast);
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
        toast.addEventListener('hidden.bs.toast', () => toast.remove());
    }
});
</script>
{% endblock %}

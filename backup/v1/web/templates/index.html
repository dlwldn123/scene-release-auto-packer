{% extends "base.html" %}

{% block title %}Dashboard - Scene Packer{% endblock %}

{% block content %}
<!-- Vérification authentification - mode public si non connecté -->
<script>
document.addEventListener('DOMContentLoaded', () => {
    // Si connecté, charger données utilisateur
    if (isAuthenticated()) {
        loadUserData().then(user => {
            if (user && user.role === 'admin') {
                const usersLink = document.getElementById('users-link');
                if (usersLink) {
                    usersLink.style.display = 'block';
                }
                // Afficher sections admin
                const adminSections = document.querySelectorAll('.admin-only');
                adminSections.forEach(section => section.style.display = 'block');
            }
            // Charger dashboard complet
            loadDashboardData();
        });
    } else {
        // Mode public : masquer sections protégées
        const protectedSections = document.querySelectorAll('.auth-required');
        protectedSections.forEach(section => section.style.display = 'none');
        
        // Afficher message de connexion
        const loginPrompt = document.getElementById('login-prompt');
        if (loginPrompt) {
            loginPrompt.style.display = 'block';
        }
    }
});
</script>

<!-- Dashboard Summary Section (auth-required) -->
<section class="dashboard-summary mb-5 fade-in auth-required" style="display: none;">
    <div class="row g-4">
        <!-- Card: Utilisateurs -->
        <div class="col-md-3">
            <div class="card slide-up h-100">
                <div class="card-body text-center">
                    <i class="fas fa-users fa-3x text-primary mb-3"></i>
                    <h3 class="mb-0" id="users-count">-</h3>
                    <p class="text-muted mb-0">Utilisateurs</p>
                </div>
            </div>
        </div>
        
        <!-- Card: Rôles -->
        <div class="col-md-3">
            <div class="card slide-up h-100">
                <div class="card-body text-center">
                    <i class="fas fa-user-tag fa-3x text-info mb-3"></i>
                    <h3 class="mb-0" id="roles-count">2</h3>
                    <p class="text-muted mb-0">Rôles</p>
                </div>
            </div>
        </div>
        
        <!-- Card: Dernières Releases -->
        <div class="col-md-3">
            <div class="card slide-up h-100">
                <div class="card-body text-center">
                    <i class="fas fa-folder-open fa-3x text-success mb-3"></i>
                    <h3 class="mb-0" id="releases-count">-</h3>
                    <p class="text-muted mb-0">Releases</p>
                </div>
            </div>
        </div>
        
        <!-- Card: Jobs -->
        <div class="col-md-3">
            <div class="card slide-up h-100">
                <div class="card-body text-center">
                    <i class="fas fa-tasks fa-3x text-warning mb-3"></i>
                    <h3 class="mb-0" id="jobs-count">-</h3>
                    <p class="text-muted mb-0">Jobs</p>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Dernières Releases (auth-required) -->
<section class="recent-releases mb-4 fade-in auth-required" style="display: none;">
    <div class="card slide-up">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-history"></i> Dernières Releases
            </h5>
            <button class="btn btn-sm btn-outline-primary" onclick="loadReleases()">
                <i class="fas fa-sync-alt"></i> Actualiser
            </button>
        </div>
        <div class="card-body">
            <div id="recent-releases-list">
                <div class="text-center py-3">
                    <i class="fas fa-spinner fa-spin"></i> Chargement...
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Message connexion si non authentifié -->
<div id="login-prompt" class="alert alert-info mb-4" style="display: none;">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <i class="fas fa-info-circle"></i> 
            <strong>Connexion requise</strong> pour accéder aux fonctionnalités complètes.
        </div>
        <a href="/login" class="btn btn-primary btn-sm">
            <i class="fas fa-sign-in-alt"></i> Se connecter
        </a>
    </div>
</div>

<!-- Hero Section -->
<div class="hero-section mb-5 fade-in">
    <div class="card text-center py-5">
        <h1 class="gradient-text mb-3">
            <i class="fas fa-rocket"></i> Professional Scene Release Tool
        </h1>
        <p class="text-muted mb-0">Package eBooks and TV Series with modern tooling and Scene Rules compliance</p>
    </div>
</div>

<!-- Section Jobs récents (auth-required) -->
<section class="recent-jobs mb-4 fade-in auth-required" style="display: none;">
    <div class="card slide-up">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-tasks"></i> Jobs Récents
            </h5>
            <a href="#jobs" class="btn btn-sm btn-outline-primary">
                <i class="fas fa-eye"></i> Voir tout
            </a>
        </div>
        <div class="card-body">
            <div id="recent-jobs-list">
                <div class="text-center py-3">
                    <i class="fas fa-spinner fa-spin"></i> Chargement...
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Upload & Pack eBook Section (auth-required) -->
<section class="upload-section card slide-up mb-4 auth-required" style="display: none; animation-delay: 0.1s">
    <div class="d-flex align-items-center justify-content-between mb-4">
        <h2 class="h4 mb-0">
            <i class="fas fa-book text-primary"></i> Upload & Pack eBook
        </h2>
        <span class="badge badge-success">Ready</span>
    </div>
    
    <div class="upload-area" id="upload-area">
        <div class="upload-content">
            <i class="fas fa-cloud-upload-alt fa-4x mb-3" style="color: var(--primary);"></i>
            <p class="h5 mb-2">Glissez-déposez un fichier eBook ici</p>
            <p class="text-muted mb-3">ou cliquez pour sélectionner</p>
            <button type="button" class="btn btn-primary">
                <i class="fas fa-folder-open"></i> Parcourir les fichiers
            </button>
            <p class="small text-muted mt-3 mb-0">
                Formats supportés: EPUB, PDF, MOBI, AZW, AZW3, CBZ
            </p>
        </div>
        <input type="file" id="ebook-file" accept=".epub,.pdf,.mobi,.azw,.azw3,.cbz" style="display: none;">
    </div>
    
    <div id="upload-status" class="mt-3"></div>
    
    <!-- Progress Bar -->
    <div id="upload-progress" class="progress mt-3" style="display: none;">
        <div class="progress-bar" role="progressbar" style="width: 0%"></div>
    </div>
</section>

<!-- Pack Options Section -->
<section class="pack-section card slide-up mb-4" id="pack-section" style="display: none; animation-delay: 0.2s">
    <h2 class="h4 mb-4">
        <i class="fas fa-cog text-primary"></i> Options de Packaging
    </h2>
    
    <form id="pack-form" class="row g-4">
        <div class="col-md-4">
            <label class="form-label">
                <i class="fas fa-users"></i> Groupe Scene
            </label>
            <div class="d-flex gap-2">
                <select id="group-select" class="form-select" required>
                    <option value="">-- Sélectionner --</option>
                </select>
                <button type="button" class="btn btn-outline-primary" id="add-group-btn">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        </div>
        
        <div class="col-md-4">
            <label class="form-label">
                <i class="fas fa-tag"></i> Type source
            </label>
            <select id="source-select" class="form-select">
                <option value="">Auto-détection</option>
                <option value="RETAIL">RETAIL</option>
                <option value="SCAN">SCAN</option>
                <option value="HYBRID">HYBRID</option>
            </select>
        </div>
        
        <div class="col-md-4">
            <label class="form-label">
                <i class="fas fa-file-code"></i> Template NFO
            </label>
            <div class="d-flex gap-2">
                <select id="nfo-template" class="form-select">
                    <option value="">Default</option>
                </select>
                <button type="button" class="btn btn-outline-secondary" id="manage-templates-btn">
                    <i class="fas fa-edit"></i>
                </button>
            </div>
        </div>
        
        <div class="col-md-6">
            <label class="form-label">
                <i class="fas fa-link"></i> URL (optionnel)
            </label>
            <input type="url" id="url-input" class="form-control" placeholder="https://...">
        </div>
        
        <div class="col-md-6 d-flex align-items-end">
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="enable-api" checked>
                <label class="form-check-label" for="enable-api">
                    <i class="fas fa-search"></i> Enrichissement API
                </label>
            </div>
        </div>
        
        <div class="col-12">
            <div class="metadata-preview" id="metadata-preview" style="display: none;">
                <h5 class="mb-3">
                    <i class="fas fa-info-circle"></i> Métadonnées détectées
                </h5>
                <dl id="metadata-dl"></dl>
            </div>
        </div>
        
        <div class="col-12">
            <button type="submit" class="btn btn-success btn-lg w-100" id="pack-btn">
                <i class="fas fa-box"></i> Créer Release
            </button>
        </div>
    </form>
    
    <div id="pack-status" class="mt-3"></div>
</section>

<!-- TV/Video Pack Section -->
<section class="tv-section card slide-up mb-4" id="tv" style="animation-delay: 0.3s">
    <h2 class="h4 mb-4">
        <i class="fas fa-video text-primary"></i> TV / Video Pack
    </h2>
    
    <form id="tv-pack-form" enctype="multipart/form-data" class="row g-4">
        <div class="col-md-6">
            <label class="form-label">
                <i class="fas fa-file-video"></i> Fichier vidéo (MKV/MP4)
            </label>
            <input type="file" id="tv-file" name="file" accept=".mkv,.mp4" class="form-control" required>
        </div>
        
        <div class="col-md-6">
            <label class="form-label">
                <i class="fas fa-heading"></i> Nom de la release
            </label>
            <input type="text" id="tv-release" name="release" class="form-control" placeholder="Ma.Release.FRENCH.1080p.WEB" required>
        </div>
        
        <div class="col-md-6">
            <label class="form-label">
                <i class="fas fa-link"></i> Lien (optionnel)
            </label>
            <input type="url" id="tv-link" name="link" class="form-control" placeholder="https://...">
        </div>
        
        <div class="col-md-6">
            <label class="form-label">
                <i class="fas fa-sliders-h"></i> Profil
            </label>
            <select id="tv-profile" name="profile" class="form-select">
                <option value="AUTO">Auto-détection</option>
                <option value="HDTV_SD">HDTV SD</option>
                <option value="HDTV_720P">HDTV 720p</option>
                <option value="HDTV_1080P">HDTV 1080p</option>
                <option value="WEB_SD">WEB SD</option>
                <option value="WEB_720P">WEB 720p</option>
                <option value="WEB_1080P">WEB 1080p</option>
                <option value="WEB_2160P">WEB 2160p</option>
            </select>
        </div>
        
        <div class="col-12">
            <button type="submit" class="btn btn-primary btn-lg w-100" id="tv-pack-btn">
                <i class="fas fa-film"></i> Créer Release TV
            </button>
        </div>
    </form>
    
    <div id="tv-pack-status" class="mt-3"></div>
</section>

<!-- Releases Section -->
<section class="releases-section card slide-up mb-4" id="releases" style="animation-delay: 0.4s">
    <div class="d-flex align-items-center justify-content-between mb-4">
        <h2 class="h4 mb-0">
            <i class="fas fa-folder-open text-primary"></i> Releases
        </h2>
        <button class="btn btn-outline-primary" id="refresh-releases">
            <i class="fas fa-sync-alt"></i> Actualiser
        </button>
    </div>
    
    <div id="releases-list" class="releases-list">
        <div class="text-center py-5">
            <i class="fas fa-spinner fa-spin fa-3x text-muted mb-3"></i>
            <p class="text-muted">Chargement des releases...</p>
        </div>
    </div>
</section>

<!-- Scene Rules Section -->
<section class="scene-rules-section card slide-up mb-4" id="scene-rules" style="animation-delay: 0.5s">
    <div class="d-flex align-items-center justify-content-between mb-4">
        <h2 class="h4 mb-0">
            <i class="fas fa-book text-primary"></i> Scene Rules
        </h2>
        <button class="btn btn-outline-primary" id="refresh-rules">
            <i class="fas fa-sync-alt"></i> Actualiser liste
        </button>
    </div>
    
    <div id="rules-list">
        <div class="text-center py-5">
            <i class="fas fa-info-circle fa-3x text-muted mb-3"></i>
            <p class="text-muted">Cliquez sur "Actualiser liste" pour charger les règles</p>
        </div>
    </div>
</section>

<!-- Scripts -->
<script>
// Charger statistiques dashboard
async function loadDashboardStats() {
    try {
        const userData = getUserData();
        
        // Charger utilisateurs (admin uniquement)
        if (userData && userData.role === 'admin') {
            try {
                const usersData = await apiRequest('/api/users');
                if (usersData.success) {
                    document.getElementById('users-count').textContent = usersData.users.length;
                }
            } catch (e) {
                console.error('Erreur chargement utilisateurs:', e);
            }
        }
        
        // Charger jobs
        try {
            const jobsData = await apiRequest('/api/jobs?limit=100');
            if (jobsData.success) {
                document.getElementById('jobs-count').textContent = jobsData.total || 0;
            }
        } catch (e) {
            console.error('Erreur chargement jobs:', e);
        }
        
        // Charger releases
        try {
            const releasesData = await apiRequest('/api/releases');
            if (releasesData.success) {
                document.getElementById('releases-count').textContent = releasesData.releases.length || 0;
                
                // Afficher dernières releases
                const recentReleases = releasesData.releases.slice(0, 5);
                const recentList = document.getElementById('recent-releases-list');
                if (recentReleases.length === 0) {
                    recentList.innerHTML = '<p class="text-muted text-center mb-0">Aucune release</p>';
                } else {
                    recentList.innerHTML = recentReleases.map(r => {
                        const date = new Date(r.created_at * 1000).toLocaleDateString('fr-FR');
                        return `
                            <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                                <div>
                                    <strong>${r.name}</strong>
                                    <br><small class="text-muted">${date}</small>
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-success">${r.zip_volumes} ZIP</span>
                                    ${r.has_nfo ? '<span class="badge bg-info ms-1">NFO</span>' : ''}
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            }
        } catch (e) {
            console.error('Erreur chargement releases:', e);
            document.getElementById('recent-releases-list').innerHTML = 
                '<p class="text-muted text-center mb-0">Erreur de chargement</p>';
        }
    } catch (e) {
        console.error('Erreur chargement stats:', e);
    }
}

// Vérifier authentification au chargement
document.addEventListener('DOMContentLoaded', () => {
    if (typeof checkAuth === 'function') {
        checkAuth();
    }
    
    // Si pas authentifié, rediriger vers login
    if (typeof isAuthenticated === 'function' && !isAuthenticated()) {
        window.location.href = '/login';
        return;
    }
    
    // Charger statistiques dashboard
    loadDashboardStats();
    
    // Fonction globale pour actualiser releases
    window.loadReleases = function() {
        loadDashboardStats();
    };
});
</script>
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
<script src="{{ url_for('static', filename='js/upload_pack.js') }}"></script>
<script src="{{ url_for('static', filename='js/wizard.js') }}"></script>
<script src="{{ url_for('static', filename='js/tv.js') }}"></script>
<script src="{{ url_for('static', filename='js/nfo_templates.js') }}"></script>

<!-- Modal Templates NFO -->
<div class="modal fade" id="nfoTemplatesModal" tabindex="-1" aria-labelledby="nfoTemplatesModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content glass-effect">
      <div class="modal-header">
        <h5 class="modal-title gradient-text" id="nfoTemplatesModalLabel">
            <i class="fas fa-file-code"></i> Templates NFO
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="nfo-modal-alert"></div>
        <div class="row g-3">
          <div class="col-md-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <strong><i class="fas fa-list"></i> Liste</strong>
              <button class="btn btn-sm btn-primary" id="nfo-btn-new">
                <i class="fas fa-plus"></i> Nouveau
              </button>
            </div>
            <div class="list-group" id="nfo-list" style="max-height: 400px; overflow-y: auto;"></div>
          </div>
          <div class="col-md-8">
            <div class="mb-3">
              <label class="form-label">
                <i class="fas fa-tag"></i> Nom
              </label>
              <input type="text" class="form-control" id="nfo-name" placeholder="ex: my_scene">
              <div class="form-text">"default" modifie le template par défaut.</div>
            </div>
            <div class="mb-3">
              <label class="form-label">
                <i class="fas fa-code"></i> Contenu
              </label>
              <textarea class="form-control" id="nfo-content" rows="12" spellcheck="false" style="font-family: monospace;"></textarea>
              <div class="form-text mt-2">
                <i class="fas fa-info-circle"></i> Variables disponibles: 
                <code>{{title}}</code>, <code>{{author}}</code>, <code>{{publisher}}</code>, 
                <code>{{year}}</code>, <code>{{language}}</code>, <code>{{isbn}}</code>, 
                <code>{{format}}</code>, <code>{{release_name}}</code>, <code>{{group}}</code>, 
                <code>{{url}}</code>, <code>{{size}}</code>, <code>{{md5}}</code>, <code>{{sha1}}</code>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer d-flex justify-content-between">
        <button type="button" class="btn btn-outline-danger" id="nfo-btn-delete">
          <i class="fas fa-trash"></i> Supprimer
        </button>
        <div>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times"></i> Fermer
          </button>
          <button type="button" class="btn btn-primary" id="nfo-btn-save">
            <i class="fas fa-save"></i> Enregistrer
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}